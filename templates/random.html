<!doctype html>
<html lang="en">

<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>3x1 Seamless Random Mix</title>
    <style>
        :root {
            --gap: 14px;
            --pad: 14px;
            --radius: 14px;
            /* GLOBAL BLACKOUT */
            --bg: #000000;
            --panel: #000000;
        }

        /* 1. Page Background */
        html,
        body {
            height: 100%;
            margin: 0;
            background-color: var(--bg);
            overflow: hidden;
        }

        .grid {
            height: 100vh;
            display: grid;
            grid-template-columns: 1fr 1fr 1fr;
            grid-template-rows: 1fr;
            gap: var(--gap);
            padding: var(--pad);
            box-sizing: border-box;
            background-color: var(--bg);
            /* Ensure gap color is black */
        }

        /* 2. Panel Background */
        .panel {
            overflow: hidden;
            border-radius: var(--radius);
            background-color: var(--panel);
            /* Black behind the content */
            position: relative;
            border: 0;
            /* Remove any debug borders */
        }

        /* 3. Content Background */
        .panel>img,
        .panel>iframe {
            width: 100%;
            height: 100%;
            border: 0;
            display: block;
            object-fit: contain;
            background-color: #000000;
            /* Black behind the image/iframe itself */
        }

        /* --- MIXER STAGE --- */
        #mixer-stage {
            position: relative;
            width: 100%;
            height: 100%;
            background-color: #000000;
            /* Black Stage */
            overflow: hidden;
        }

        /* 4. Layer Background */
        .mix-layer {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            object-fit: contain;
            border: 0;
            background-color: #000000 !important;
            will-change: opacity;
            opacity: 0;
            transition: opacity 3000ms ease-in-out;
            max-width: 100%;
            max-height: 100%;
        }

        /* Ensure iframes match the contained video rectangle */
        iframe.mix-layer {
            position: absolute;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;

            /* Allow JS to shrink it to match the contained video rect */
            min-width: 0;
            min-height: 0;
            max-width: 100%;
            max-height: 100%;

            margin: 0;
            padding: 0;
            display: block;
            border: 0;
            box-sizing: border-box;
        }
    </style>
</head>

<body>
    <div class="grid">

        <div class="panel">
            <img src="/video_feed" />
        </div>

        <div class="panel">
            <img src="https://testing2.gencarelle.fun/video_feed" />
        </div>

        <div class="panel">
            <div id="mixer-stage">
                <iframe class="mix-layer" id="src-0" src="/ascii" scrolling="no"
                    style="opacity: 1; z-index: 10;"></iframe>

                <iframe class="mix-layer" id="src-1" src="https://testing2.gencarelle.fun/ascii" scrolling="no"
                    style="z-index: 0;"></iframe>

                <img class="mix-layer" id="src-2" src="/video_feed" style="z-index: 0;" />

                <img class="mix-layer" id="src-3" src="https://testing2.gencarelle.fun/video_feed"
                    style="z-index: 0;" />
            </div>
        </div>

    </div>

    <script>
        /* --- CONFIG --- */
        const SHOW_TIME = 4000;     // Static time (ms)
        const FADE_DURATION = 2000; // Fade time (ms)

        const LAYERS = [
            document.getElementById('src-0'),
            document.getElementById('src-1'),
            //document.getElementById('src-2'),
            document.getElementById('src-3')
        ];

        let currentIdx = 0;

        function triggerNextFade() {
            // 1. Pick Random Next Layer
            let nextIdx;
            do {
                nextIdx = Math.floor(Math.random() * LAYERS.length);
            } while (nextIdx === currentIdx);

            const currentEl = LAYERS[currentIdx];
            const nextEl = LAYERS[nextIdx];

            // 2. Setup (Place on top)
            nextEl.style.zIndex = 20;
            currentEl.style.zIndex = 10;

            // Reset others
            LAYERS.forEach((el, i) => {
                if (i !== currentIdx && i !== nextIdx) {
                    el.style.zIndex = 0;
                    el.style.opacity = 0;
                }
            });

            // Force Reflow
            void nextEl.offsetWidth;

            // 3. Animate (Fade In)
            nextEl.style.opacity = 1;

            // 4. Cleanup
            setTimeout(() => {
                currentEl.style.opacity = 0;
                currentEl.style.zIndex = 0;
                nextEl.style.zIndex = 10;
                currentIdx = nextIdx;

                setTimeout(triggerNextFade, SHOW_TIME);
            }, FADE_DURATION);
        }

        // Start
        setTimeout(triggerNextFade, SHOW_TIME);

        /* --- SCALE ASCII IFRAMES TO MATCH VIDEO_FEED SIZE --- */
        function computeContainRect(containerW, containerH, contentAR) {
            const containerAR = containerW / containerH;

            let w, h;
            if (containerAR > contentAR) {
                // Container is wider: fit height
                h = containerH;
                w = h * contentAR;
            } else {
                // Container is taller/narrower: fit width
                w = containerW;
                h = w / contentAR;
            }

            return {
                width: w,
                height: h,
                left: (containerW - w) / 2,
                top: (containerH - h) / 2
            };
        }

        function scaleAsciiToVideoSize() {
            const mixerStage = document.getElementById('mixer-stage');
            const stageW = mixerStage.clientWidth;
            const stageH = mixerStage.clientHeight;
            if (!stageW || !stageH) return;

            // Pick any video layer image. Prefer one that is actually present.
            const videoImg =
                document.getElementById('src-3') ||
                document.getElementById('src-2') ||
                document.querySelector('#mixer-stage img.mix-layer[src*="video_feed"]');

            // Determine aspect ratio of the video feed
            let videoAR = 16 / 9; // sane default
            if (videoImg && videoImg.naturalWidth > 0 && videoImg.naturalHeight > 0) {
                videoAR = videoImg.naturalWidth / videoImg.naturalHeight;
            }

            const r = computeContainRect(stageW, stageH, videoAR);

            document.querySelectorAll('#mixer-stage iframe.mix-layer').forEach(iframe => {
                iframe.style.width = r.width + 'px';
                iframe.style.height = r.height + 'px';
                iframe.style.left = r.left + 'px';
                iframe.style.top = r.top + 'px';
            });
        }

        // Run after layout settles
        window.addEventListener('load', () => {
            requestAnimationFrame(() => {
                requestAnimationFrame(scaleAsciiToVideoSize);
            });
        });
        window.addEventListener('resize', scaleAsciiToVideoSize);

        // Call scaleAsciiToVideoSize() periodically for a short time to catch stream init
        let scaleTries = 0;
        const scaleTimer = setInterval(() => {
            scaleAsciiToVideoSize();
            scaleTries += 1;
            if (scaleTries >= 20) clearInterval(scaleTimer); // ~4 seconds at 200ms
        }, 200);
    </script>
</body>

</html>