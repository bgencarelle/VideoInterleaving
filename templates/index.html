<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <title>VideoInterleaving Stream</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta name="color-scheme" content="dark">
  <link rel="stylesheet" href="/static/stream.css">
</head>
<body class="contain no-cursor rot0">
  <div class="stage">
    <img id="video" src="/video_feed" alt="Live MJPEG stream" draggable="false">
  </div>

  <div class="ui" role="toolbar" aria-label="Viewer controls">
    <button id="fitToggle" aria-pressed="false" title="Toggle fit (C)">Contain</button>
    <button id="rotateToggle" title="Rotate (R)">Rotate</button>
    <button id="fsToggle" title="Fullscreen (F)">Fullscreen</button>
  </div>

  <noscript><div class="noscript">JS handles buttons/cursor; the MJPEG stream still loads without it.</div></noscript>

  <script>
    // ===== UI quick-hide + cursor hide =====
    const body   = document.body;
    const fitBtn = document.getElementById('fitToggle');
    const rotBtn = document.getElementById('rotateToggle');
    const fsBtn  = document.getElementById('fsToggle');

    const UI_HIDE_MS = 600;
    let uiTimer = null;

    function revealUI() {
      body.classList.add('ui-visible');
      body.classList.remove('no-cursor');
      clearTimeout(uiTimer);
      uiTimer = setTimeout(() => {
        if (!document.querySelector('.ui :focus')) {
          body.classList.remove('ui-visible');
          body.classList.add('no-cursor');
        } else {
          uiTimer = setTimeout(() => {
            body.classList.remove('ui-visible');
            body.classList.add('no-cursor');
          }, UI_HIDE_MS);
        }
      }, UI_HIDE_MS);
    }

    function setFit(mode) {
      body.classList.toggle('cover',   mode === 'cover');
      body.classList.toggle('contain', mode === 'contain');
      fitBtn.textContent = (mode === 'cover') ? 'Cover' : 'Contain';
      fitBtn.setAttribute('aria-pressed', mode === 'cover');
      revealUI();
    }
    function toggleFit() {
      setFit(body.classList.contains('cover') ? 'contain' : 'cover');
    }

    // Rotation: body has one of rot0/rot90/rot180/rot270
    const ROT_SEQUENCE = ['rot0','rot90','rot180','rot270'];
    function currentRotIndex() {
      return ROT_SEQUENCE.findIndex(c => body.classList.contains(c));
    }
    function rotateStep() {
      const idx = currentRotIndex();
      const next = ROT_SEQUENCE[(idx + 1) % ROT_SEQUENCE.length];
      ROT_SEQUENCE.forEach(c => body.classList.remove(c));
      body.classList.add(next);
      revealUI();
    }

    function toggleFullscreen() {
      if (!document.fullscreenElement) {
        document.documentElement.requestFullscreen().catch(()=>{});
      } else {
        document.exitFullscreen().catch(()=>{});
      }
      revealUI();
    }

    // Show UI briefly on activity
    ['mousemove','pointermove','touchstart','keydown','resize','orientationchange'].forEach(ev =>
      window.addEventListener(ev, revealUI, {passive:true})
    );

    // Keep UI visible while hovering the toolbar
    const toolbar = document.querySelector('.ui');
    toolbar.addEventListener('mouseenter', () => {
      clearTimeout(uiTimer);
      body.classList.add('ui-visible');
      body.classList.remove('no-cursor');
    });
    toolbar.addEventListener('mouseleave', revealUI);

    // Buttons & shortcuts
    fitBtn.addEventListener('click', toggleFit);
    rotBtn.addEventListener('click', rotateStep);
    fsBtn.addEventListener('click',  toggleFullscreen);
    window.addEventListener('keydown', (e) => {
      if (e.key === 'c' || e.key === 'C') toggleFit();
      if (e.key === 'r' || e.key === 'R') rotateStep();
      if (e.key === 'f' || e.key === 'F') toggleFullscreen();
    });
    document.addEventListener('dblclick', toggleFullscreen);

    // Auto-fit: in portrait viewports, default to 'cover' to eliminate letterboxing.
    function applyAutoFit() {
      const portrait = window.matchMedia('(orientation: portrait)').matches;
      setFit(portrait ? 'cover' : 'contain');
    }

    // Initial state
    applyAutoFit();
    revealUI();
    window.matchMedia('(orientation: portrait)').addEventListener('change', applyAutoFit);
    window.addEventListener('resize', applyAutoFit);
  </script>
</body>
</html>
