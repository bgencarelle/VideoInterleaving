<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <title>VideoInterleaving Terminal</title>

  <link rel="stylesheet" href="/static/xterm.css" />

  <link rel="stylesheet" href="/static/terminal.css" />

  <script src="/static/xterm.js" onerror="alert('CRITICAL ERROR: /static/xterm.js not found.')"></script>
</head>
<body>

  <div id="terminal-stage">
    <div id="terminal"></div>
  </div>

  <script>
    const WS_PORT = 2324;

    // --- 1. CONFIGURATION (Strictly from Settings) ---
    const COLS = parseInt("{{ASCII_WIDTH}}") || 80;
    const ROWS = parseInt("{{ASCII_HEIGHT}}") || 24;

    // --- 2. SETUP TERMINAL ---
    if (typeof Terminal === 'undefined') {
        throw new Error("xterm.js library missing");
    }

    const term = new Terminal({
      cols: COLS,
      rows: ROWS,
      fontFamily: 'Courier New, monospace',
      fontSize: 14,
      lineHeight: 1.0,
      cursorBlink: false,
      disableStdin: true,
      theme: { background: '#000000', foreground: '#e6e6e6' },
      allowTransparency: false
    });

    term.open(document.getElementById('terminal'));

    // --- 3. SCALING LOGIC ---
    function fitToScreen() {
      const termEl = document.getElementById('terminal');
      // Verify screen element exists (this is what has the width/height)
      const screenEl = termEl.querySelector('.xterm-screen');
      if (!screenEl) return;

      const srcW = screenEl.clientWidth;
      const srcH = screenEl.clientHeight;
      if (srcW < 1 || srcH < 1) return;

      const targetW = window.innerWidth;
      const targetH = window.innerHeight;

      // Scale to fit screen edges
      const scale = Math.min(targetW / srcW, targetH / srcH);

      termEl.style.transform = `scale(${scale})`;
    }

    // --- 4. WEBSOCKET ---
    function connect() {
      const protocol = location.protocol === 'https:' ? 'wss://' : 'ws://';
      const wsUrl = protocol + location.hostname + ":" + WS_PORT;

      const ws = new WebSocket(wsUrl);
      ws.binaryType = "arraybuffer";

      ws.onopen = () => {
        term.reset();
        setTimeout(fitToScreen, 50);
      };

      ws.onmessage = (ev) => {
        term.write(ev.data);
      };

      ws.onclose = () => setTimeout(connect, 2000);
      ws.onerror = () => ws.close();
    }

    // --- START ---
    window.addEventListener('resize', () => requestAnimationFrame(fitToScreen));
    setTimeout(() => {
        fitToScreen();
        connect();
    }, 100);
  </script>
</body>
</html>