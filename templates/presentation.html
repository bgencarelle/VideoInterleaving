<!doctype html>
<html lang="en">
<head>
    <meta charset="utf-8"/>
    <meta name="viewport" content="width=device-width,initial-scale=1"/>
    <title>4x1 Seamless Random Mix</title>
    <style>
        :root {
            --gap: 14px;
            --pad: 14px;
            --radius: 14px;
            /* GLOBAL BLACKOUT */
            --bg: #000000;
            --panel: #000000;
        }

        html, body {
            height: 100%;
            margin: 0;
            background-color: var(--bg);
            overflow: hidden;
        }

        .grid {
            height: 100vh;
            display: grid;
            /* was 3 columns; now 4 */
            grid-template-columns: 1fr 1fr 1fr 1fr;
            grid-template-rows: 1fr;
            gap: var(--gap);
            padding: var(--pad);
            box-sizing: border-box;
            background-color: var(--bg);
        }

        .panel {
            overflow: hidden;
            border-radius: var(--radius);
            background-color: var(--panel);
            position: relative;
            border: 0;
        }

        .panel > img, .panel > iframe {
            width: 100%;
            height: 100%;
            border: 0;
            display: block;
            object-fit: contain;
            background-color: #000000;
        }

        #mixer-stage {
            position: relative;
            width: 100%;
            height: 100%;
            background-color: #000000;
            overflow: hidden;
        }

        .mix-layer {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            object-fit: contain;
            border: 0;
            background-color: #000000 !important;
            will-change: opacity;
            opacity: 0;
            transition: opacity 3000ms ease-in-out;
            max-width: 100%;
            max-height: 100%;
        }
        
        /* Ensure iframes fill container completely with minimum spacing */
        /* The iframe should match the image aspect ratio, not the terminal aspect ratio */
        iframe.mix-layer {
            /* Override mix-layer positioning for iframes */
            position: absolute;
            left: 0;
            top: 0;
            /* Fill container completely */
            width: 100%;
            height: 100%;
            /* Ensure minimum size - fill at least 100% of container */
            min-width: 100%;
            min-height: 100%;
            max-width: 100%;
            max-height: 100%;
            margin: 0;
            padding: 0;
            display: block;
            /* Remove any default spacing */
            border: 0;
            box-sizing: border-box;
        }
    </style>
</head>
<body>
<div class="grid">

    <div class="panel">
        <img src="/video_feed"/>
    </div>

    <div class="panel">
        <img src="https://testing2.gencarelle.fun/video_feed"/>
    </div>

    <div class="panel">
        <img src="https://testing3.gencarelle.fun/video_feed"/>
    </div>

    <div class="panel">
        <div id="mixer-stage">
            <!-- ASCII layers -->
            <iframe class="mix-layer" id="src-0" src="/ascii"
                    scrolling="no" style="opacity: 1; z-index: 10;"></iframe>

            <iframe class="mix-layer" id="src-1" src="https://testing2.gencarelle.fun/ascii"
                    scrolling="no" style="z-index: 0;"></iframe>

            <iframe class="mix-layer" id="src-4" src="https://testing3.gencarelle.fun/ascii"
                    scrolling="no" style="z-index: 0;"></iframe>

            <!-- video_feed layers -->
            <img class="mix-layer" id="src-2" src="/video_feed" style="z-index: 0;"/>

            <img class="mix-layer" id="src-3" src="https://testing2.gencarelle.fun/video_feed" style="z-index: 0;"/>

            <img class="mix-layer" id="src-5" src="https://testing3.gencarelle.fun/video_feed" style="z-index: 0;"/>
        </div>
    </div>

</div>

<script>
    /* --- CONFIG --- */
    const SHOW_TIME = 4000;     // Static time (ms)
    const FADE_DURATION = 2000; // Fade time (ms)

    // Pick whichever mix sources you actually want to include.
    // If you want *all* six possible layers, include them all.
    const LAYERS = [
        document.getElementById('src-0'), // ascii 1
        document.getElementById('src-1'), // ascii 2
        document.getElementById('src-4'), // ascii 3
        // document.getElementById('src-2'), // video 1 (uncomment to include)
        document.getElementById('src-3'), // video 2
        document.getElementById('src-5')  // video 3
    ];

    let currentIdx = 0;

    function triggerNextFade() {
        // 1. Pick Random Next Layer
        let nextIdx;
        do {
            nextIdx = Math.floor(Math.random() * LAYERS.length);
        } while (nextIdx === currentIdx);

        const currentEl = LAYERS[currentIdx];
        const nextEl = LAYERS[nextIdx];

        // 2. Setup (Place on top)
        nextEl.style.zIndex = 20;
        currentEl.style.zIndex = 10;

        // Reset others
        LAYERS.forEach((el, i) => {
            if (i !== currentIdx && i !== nextIdx) {
                el.style.zIndex = 0;
                el.style.opacity = 0;
            }
        });

        // Force Reflow
        void nextEl.offsetWidth;

        // 3. Animate (Fade In)
        nextEl.style.opacity = 1;

        // 4. Cleanup
        setTimeout(() => {
            currentEl.style.opacity = 0;
            currentEl.style.zIndex = 0;
            nextEl.style.zIndex = 10;
            currentIdx = nextIdx;

            setTimeout(triggerNextFade, SHOW_TIME);
        }, FADE_DURATION);
    }

    // Start
    setTimeout(triggerNextFade, SHOW_TIME);

    /* --- SCALE ASCII IFRAMES TO MATCH VIDEO_FEED SIZE --- */
    function scaleAsciiToVideoSize() {
        // Find a video_feed image to measure (use the first one in mixer-stage)
        const videoImg = document.querySelector('#mixer-stage .mix-layer[src*="video_feed"]');
        if (!videoImg) return;
        
        // Wait for image to load if not already loaded
        if (!videoImg.complete) {
            videoImg.addEventListener('load', scaleAsciiToVideoSize);
            return;
        }
        
        // Get actual rendered dimensions of the video image
        const videoRect = videoImg.getBoundingClientRect();
        const mixerStage = document.getElementById('mixer-stage');
        const stageRect = mixerStage.getBoundingClientRect();
        
        // Calculate the scale factor needed
        // Video uses object-fit: contain, so we need to match its actual size
        const scaleX = videoRect.width / stageRect.width;
        const scaleY = videoRect.height / stageRect.height;
        
        // Apply scaling to all ASCII iframes
        document.querySelectorAll('#mixer-stage iframe.mix-layer').forEach(iframe => {
            // Create a frame container that matches video size
            iframe.style.width = videoRect.width + 'px';
            iframe.style.height = videoRect.height + 'px';
            iframe.style.left = ((stageRect.width - videoRect.width) / 2) + 'px';
            iframe.style.top = ((stageRect.height - videoRect.height) / 2) + 'px';
            iframe.style.transform = 'none';
            iframe.style.transformOrigin = 'center center';
        });
    }

    // Scale on load and resize
    window.addEventListener('load', () => {
        // Wait a bit for images to render
        setTimeout(scaleAsciiToVideoSize, 100);
    });
    window.addEventListener('resize', scaleAsciiToVideoSize);
    
    // Also scale when video images load
    document.querySelectorAll('#mixer-stage .mix-layer[src*="video_feed"]').forEach(img => {
        if (img.complete) {
            scaleAsciiToVideoSize();
        } else {
            img.addEventListener('load', scaleAsciiToVideoSize);
        }
    });
</script>
</body>
</html>
